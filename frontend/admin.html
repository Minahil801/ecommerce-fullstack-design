<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Panel - Brand</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body { font-family: 'Segoe UI', sans-serif; background:#f0f2f5; color:#2B3445; }

    /* SIDEBAR */
    .sidebar { position:fixed; top:0; left:0; width:240px; height:100vh; background:#2B3445; color:#fff; display:flex; flex-direction:column; z-index:100; }
    .sidebar-logo { padding:24px 20px; border-bottom:1px solid rgba(255,255,255,0.1); display:flex; align-items:center; gap:10px; }
    .sidebar-logo i { color:#0D6EFD; font-size:22px; }
    .sidebar-logo h2 { font-size:18px; font-weight:800; }
    .sidebar-logo span { font-size:11px; color:#0D6EFD; background:rgba(13,110,253,0.15); padding:2px 8px; border-radius:10px; margin-left:4px; }
    .sidebar-nav { padding:16px 0; flex:1; }
    .nav-item { display:flex; align-items:center; gap:12px; padding:12px 20px; color:rgba(255,255,255,0.7); cursor:pointer; transition:all 0.2s; font-size:14px; border-left:3px solid transparent; }
    .nav-item:hover  { background:rgba(255,255,255,0.08); color:#fff; }
    .nav-item.active { background:rgba(13,110,253,0.2); color:#0D6EFD; border-left-color:#0D6EFD; }
    .nav-item i { width:20px; text-align:center; }
    .sidebar-footer { padding:16px 20px; border-top:1px solid rgba(255,255,255,0.1); }
    .admin-info { display:flex; align-items:center; gap:10px; }
    .admin-avatar { width:36px; height:36px; border-radius:50%; background:#0D6EFD; display:flex; align-items:center; justify-content:center; font-weight:700; font-size:14px; }
    .admin-name { font-size:13px; font-weight:600; }
    .admin-role { font-size:11px; color:#0D6EFD; }
    .logout-btn { margin-top:10px; width:100%; padding:8px; background:rgba(220,53,69,0.15); color:#dc3545; border:1px solid rgba(220,53,69,0.3); border-radius:6px; cursor:pointer; font-size:13px; transition:all 0.2s; }
    .logout-btn:hover { background:rgba(220,53,69,0.25); }

    /* MAIN */
    .main { margin-left:240px; min-height:100vh; }
    .topbar { background:#fff; padding:16px 28px; display:flex; align-items:center; justify-content:space-between; box-shadow:0 1px 4px rgba(0,0,0,0.08); position:sticky; top:0; z-index:50; }
    .topbar h1 { font-size:20px; font-weight:800; color:#2B3445; }
    .topbar-right { display:flex; align-items:center; gap:12px; }
    .btn { padding:9px 18px; border-radius:8px; font-size:13px; font-weight:600; cursor:pointer; border:none; display:flex; align-items:center; gap:6px; transition:all 0.2s; }
    .btn-primary { background:#0D6EFD; color:#fff; }
    .btn-primary:hover { background:#0b5ed7; transform:translateY(-1px); }
    .btn-danger  { background:#dc3545; color:#fff; }
    .btn-danger:hover  { background:#bb2d3b; }
    .btn-success { background:#28a745; color:#fff; }
    .btn-success:hover { background:#218838; }
    .btn-outline { background:#fff; color:#555; border:1px solid #ddd; }
    .btn-outline:hover { border-color:#0D6EFD; color:#0D6EFD; }

    /* CONTENT */
    .content { padding:28px; }

    /* STATS */
    .stats-grid { display:grid; grid-template-columns:repeat(4,1fr); gap:20px; margin-bottom:28px; }
    .stat-card { background:#fff; border-radius:14px; padding:22px; display:flex; align-items:center; gap:16px; box-shadow:0 2px 8px rgba(0,0,0,0.06); }
    .stat-icon { width:52px; height:52px; border-radius:12px; display:flex; align-items:center; justify-content:center; font-size:22px; flex-shrink:0; }
    .stat-icon.blue   { background:#e8f0fe; color:#0D6EFD; }
    .stat-icon.green  { background:#d4edda; color:#28a745; }
    .stat-icon.orange { background:#fff3cd; color:#fd7e14; }
    .stat-icon.red    { background:#f8d7da; color:#dc3545; }
    .stat-info h3 { font-size:26px; font-weight:800; color:#2B3445; }
    .stat-info p  { font-size:13px; color:#888; margin-top:2px; }

    /* TOOLBAR */
    .toolbar { background:#fff; border-radius:14px; padding:18px 20px; margin-bottom:20px; display:flex; align-items:center; gap:12px; flex-wrap:wrap; box-shadow:0 2px 8px rgba(0,0,0,0.06); }
    .search-box { flex:1; min-width:200px; position:relative; }
    .search-box input { width:100%; padding:9px 12px 9px 36px; border:1px solid #ddd; border-radius:8px; font-size:13px; outline:none; }
    .search-box input:focus { border-color:#0D6EFD; }
    .search-box i { position:absolute; left:12px; top:50%; transform:translateY(-50%); color:#aaa; }
    .filter-select { padding:9px 12px; border:1px solid #ddd; border-radius:8px; font-size:13px; outline:none; color:#555; cursor:pointer; }
    .filter-select:focus { border-color:#0D6EFD; }

    /* TABLE */
    .table-card { background:#fff; border-radius:14px; box-shadow:0 2px 8px rgba(0,0,0,0.06); overflow:hidden; }
    .table-header { padding:18px 20px; border-bottom:1px solid #f0f0f0; display:flex; align-items:center; justify-content:space-between; }
    .table-header h3 { font-size:16px; font-weight:700; }
    .products-count { font-size:13px; color:#888; }
    table { width:100%; border-collapse:collapse; }
    thead th { padding:12px 16px; text-align:left; font-size:12px; font-weight:700; color:#888; text-transform:uppercase; letter-spacing:0.5px; background:#f8f9fa; border-bottom:1px solid #eee; }
    tbody tr { border-bottom:1px solid #f5f5f5; transition:background 0.15s; }
    tbody tr:hover { background:#f8f9ff; }
    tbody td { padding:14px 16px; font-size:13px; vertical-align:middle; }
    .product-thumb { width:48px; height:48px; border-radius:8px; object-fit:cover; }
    .product-name { font-weight:600; color:#2B3445; max-width:200px; }
    .product-brand { font-size:12px; color:#888; margin-top:2px; }
    .category-badge { display:inline-block; padding:3px 10px; border-radius:12px; font-size:11px; font-weight:600; background:#e8f0fe; color:#0D6EFD; }
    .price-cell { font-weight:700; color:#0D6EFD; }
    .old-price { font-size:11px; color:#aaa; text-decoration:line-through; display:block; }
    .stock-badge { display:inline-flex; align-items:center; gap:4px; padding:3px 10px; border-radius:12px; font-size:11px; font-weight:600; }
    .stock-ok   { background:#d4edda; color:#155724; }
    .stock-low  { background:#fff3cd; color:#856404; }
    .stock-out  { background:#f8d7da; color:#721c24; }
    .action-btns { display:flex; gap:6px; }
    .btn-sm { padding:6px 10px; border-radius:6px; font-size:12px; cursor:pointer; border:none; font-weight:600; transition:all 0.15s; }
    .btn-edit   { background:#e8f0fe; color:#0D6EFD; }
    .btn-edit:hover   { background:#0D6EFD; color:#fff; }
    .btn-delete { background:#f8d7da; color:#dc3545; }
    .btn-delete:hover { background:#dc3545; color:#fff; }
    .empty-state { text-align:center; padding:60px 20px; color:#888; }
    .empty-state i { font-size:48px; opacity:0.3; display:block; margin-bottom:12px; }

    /* MODAL */
    .modal-overlay { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; display:none; align-items:center; justify-content:center; backdrop-filter:blur(4px); }
    .modal-overlay.show { display:flex; }
    .modal { background:#fff; border-radius:16px; width:560px; max-width:95vw; max-height:90vh; overflow-y:auto; box-shadow:0 20px 60px rgba(0,0,0,0.3); }
    .modal-header { padding:20px 24px; border-bottom:1px solid #f0f0f0; display:flex; align-items:center; justify-content:space-between; position:sticky; top:0; background:#fff; z-index:1; }
    .modal-header h3 { font-size:18px; font-weight:700; }
    .modal-close { background:none; border:none; font-size:20px; cursor:pointer; color:#888; padding:4px 8px; border-radius:6px; }
    .modal-close:hover { background:#f0f0f0; }
    .modal-body { padding:24px; }
    .modal-footer { padding:16px 24px; border-top:1px solid #f0f0f0; display:flex; gap:10px; justify-content:flex-end; }
    .form-row { display:grid; grid-template-columns:1fr 1fr; gap:16px; }
    .form-group { margin-bottom:16px; }
    .form-group label { display:block; font-size:13px; font-weight:600; color:#555; margin-bottom:6px; }
    .form-group input, .form-group select, .form-group textarea {
      width:100%; padding:10px 12px; border:1px solid #ddd; border-radius:8px; font-size:13px; outline:none; font-family:inherit; transition:border-color 0.2s;
    }
    .form-group input:focus, .form-group select:focus, .form-group textarea:focus { border-color:#0D6EFD; box-shadow:0 0 0 3px rgba(13,110,253,0.1); }
    .form-group textarea { resize:vertical; min-height:80px; }
    .img-preview { width:100%; height:120px; object-fit:cover; border-radius:8px; margin-top:8px; border:1px solid #eee; display:none; }

    /* TOAST */
    .toast { position:fixed; bottom:24px; right:24px; padding:14px 20px; border-radius:10px; color:#fff; font-size:14px; font-weight:600; z-index:9999; display:flex; align-items:center; gap:10px; box-shadow:0 4px 20px rgba(0,0,0,0.2); transform:translateY(80px); opacity:0; transition:all 0.3s; }
    .toast.show { transform:translateY(0); opacity:1; }
    .toast.success { background:#28a745; }
    .toast.error   { background:#dc3545; }

    /* LOADING */
    .loading { text-align:center; padding:60px; color:#888; }
    .spinner { width:40px; height:40px; border:3px solid #f0f0f0; border-top-color:#0D6EFD; border-radius:50%; animation:spin 0.8s linear infinite; margin:0 auto 16px; }
    @keyframes spin { to { transform:rotate(360deg); } }

    /* ACCESS DENIED */
    .access-denied { display:flex; flex-direction:column; align-items:center; justify-content:center; min-height:100vh; text-align:center; }
    .access-denied i { font-size:64px; color:#dc3545; margin-bottom:20px; }
    .access-denied h2 { font-size:28px; font-weight:800; margin-bottom:10px; }
    .access-denied p { color:#888; margin-bottom:24px; }

    /* RESPONSIVE */
    @media (max-width:768px) {
      .sidebar { width:60px; }
      .sidebar-logo h2, .sidebar-logo span, .nav-item span, .admin-name, .admin-role, .logout-btn { display:none; }
      .main { margin-left:60px; }
      .stats-grid { grid-template-columns:1fr 1fr; }
      .form-row { grid-template-columns:1fr; }
    }
  </style>
</head>
<body>

<!-- ACCESS CHECK -->
<div id="accessDenied" class="access-denied" style="display:none;">
  <i class="fa fa-lock"></i>
  <h2>Access Denied!</h2>
  <p>You need admin privileges to access this page.</p>
  <a href="login.html" style="background:#0D6EFD;color:#fff;padding:12px 28px;border-radius:8px;text-decoration:none;font-weight:700;">
    <i class="fa fa-sign-in-alt"></i> Login as Admin
  </a>
</div>

<!-- ADMIN PANEL -->
<div id="adminPanel" style="display:none;">

  <!-- SIDEBAR -->
  <div class="sidebar">
    <div class="sidebar-logo">
      <i class="fa fa-bolt"></i>
      <h2>Brand <span>ADMIN</span></h2>
    </div>
    <nav class="sidebar-nav">
      <div class="nav-item active" onclick="showSection('products')">
        <i class="fa fa-box"></i><span>Products</span>
      </div>
      <div class="nav-item" onclick="window.open('index.html','_blank')">
        <i class="fa fa-store"></i><span>View Store</span>
      </div>
    </nav>
    <div class="sidebar-footer">
      <div class="admin-info">
        <div class="admin-avatar" id="adminAvatar">A</div>
        <div>
          <div class="admin-name" id="adminName">Admin</div>
          <div class="admin-role">Administrator</div>
        </div>
      </div>
      <button class="logout-btn" onclick="adminLogout()">
        <i class="fa fa-sign-out-alt"></i> Logout
      </button>
    </div>
  </div>

  <!-- MAIN CONTENT -->
  <div class="main">
    <div class="topbar">
      <h1 id="pageTitle">Products Management</h1>
      <div class="topbar-right">
        <button class="btn btn-primary" onclick="openAddModal()">
          <i class="fa fa-plus"></i> Add Product
        </button>
      </div>
    </div>

    <div class="content">

      <!-- STATS -->
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-icon blue"><i class="fa fa-box"></i></div>
          <div class="stat-info"><h3 id="totalProducts">0</h3><p>Total Products</p></div>
        </div>
        <div class="stat-card">
          <div class="stat-icon green"><i class="fa fa-check-circle"></i></div>
          <div class="stat-info"><h3 id="inStockCount">0</h3><p>In Stock</p></div>
        </div>
        <div class="stat-card">
          <div class="stat-icon orange"><i class="fa fa-exclamation-triangle"></i></div>
          <div class="stat-info"><h3 id="lowStockCount">0</h3><p>Low Stock</p></div>
        </div>
        <div class="stat-card">
          <div class="stat-icon red"><i class="fa fa-times-circle"></i></div>
          <div class="stat-info"><h3 id="outStockCount">0</h3><p>Out of Stock</p></div>
        </div>
      </div>

      <!-- TOOLBAR -->
      <div class="toolbar">
        <div class="search-box">
          <i class="fa fa-search"></i>
          <input type="text" id="searchInput" placeholder="Search products..." oninput="filterProducts()"/>
        </div>
        <select class="filter-select" id="catFilter" onchange="filterProducts()">
          <option value="">All Categories</option>
          <option>Electronics</option>
          <option>Gadgets</option>
          <option>Clothing</option>
          <option>Sports</option>
          <option>Home</option>
          <option>Kitchen</option>
          <option>Garden</option>
          <option>Jewelry</option>
        </select>
        <select class="filter-select" id="stockFilter" onchange="filterProducts()">
          <option value="">All Stock</option>
          <option value="in">In Stock</option>
          <option value="low">Low Stock</option>
          <option value="out">Out of Stock</option>
        </select>
      </div>

      <!-- TABLE -->
      <div class="table-card">
        <div class="table-header">
          <h3>All Products</h3>
          <span class="products-count" id="productsCount">Loading...</span>
        </div>
        <div id="tableBody">
          <div class="loading">
            <div class="spinner"></div>
            <p>Loading products...</p>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>

<!-- ADD/EDIT MODAL -->
<div class="modal-overlay" id="productModal">
  <div class="modal">
    <div class="modal-header">
      <h3 id="modalTitle">Add New Product</h3>
      <button class="modal-close" onclick="closeModal()">‚úï</button>
    </div>
    <div class="modal-body">
      <input type="hidden" id="productId"/>
      <div class="form-row">
        <div class="form-group">
          <label>Product Name *</label>
          <input type="text" id="pName" placeholder="e.g. Sony Headphones"/>
        </div>
        <div class="form-group">
          <label>Brand *</label>
          <input type="text" id="pBrand" placeholder="e.g. Sony"/>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Category *</label>
          <select id="pCategory">
            <option value="">Select Category</option>
            <option>Electronics</option>
            <option>Gadgets</option>
            <option>Clothing</option>
            <option>Sports</option>
            <option>Home</option>
            <option>Kitchen</option>
            <option>Garden</option>
            <option>Jewelry</option>
          </select>
        </div>
        <div class="form-group">
          <label>Stock *</label>
          <input type="number" id="pStock" placeholder="e.g. 50" min="0"/>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Price ($) *</label>
          <input type="number" id="pPrice" placeholder="e.g. 299.99" step="0.01" min="0"/>
        </div>
        <div class="form-group">
          <label>Old Price ($) <span style="color:#aaa;font-weight:400;">(optional)</span></label>
          <input type="number" id="pOldPrice" placeholder="e.g. 399.99" step="0.01" min="0"/>
        </div>
      </div>
      <div class="form-group">
        <label>Image URL *</label>
        <input type="text" id="pImage" placeholder="https://images.unsplash.com/..." oninput="previewImg()"/>
        <img id="imgPreview" class="img-preview" alt="Preview"/>
      </div>
      <div class="form-group">
        <label>Description</label>
        <textarea id="pDesc" placeholder="Product description..."></textarea>
      </div>
      <div id="modalError" style="color:#dc3545;font-size:13px;margin-top:4px;display:none;"></div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline" onclick="closeModal()">Cancel</button>
      <button class="btn btn-primary" id="saveBtn" onclick="saveProduct()">
        <i class="fa fa-save"></i> Save Product
      </button>
    </div>
  </div>
</div>

<!-- DELETE CONFIRM MODAL -->
<div class="modal-overlay" id="deleteModal">
  <div class="modal" style="width:420px;">
    <div class="modal-header">
      <h3>Delete Product</h3>
      <button class="modal-close" onclick="closeDeleteModal()">‚úï</button>
    </div>
    <div class="modal-body" style="text-align:center;padding:32px;">
      <i class="fa fa-trash" style="font-size:48px;color:#dc3545;margin-bottom:16px;display:block;"></i>
      <h4 style="margin-bottom:8px;font-size:16px;">Are you sure?</h4>
      <p style="color:#888;font-size:14px;" id="deleteProductName">This product will be permanently deleted!</p>
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline" onclick="closeDeleteModal()">Cancel</button>
      <button class="btn btn-danger" onclick="confirmDelete()">
        <i class="fa fa-trash"></i> Delete
      </button>
    </div>
  </div>
</div>

<!-- TOAST -->
<div class="toast" id="toast"><i class="fa fa-check-circle"></i><span id="toastMsg"></span></div>

<script>
var API     = 'http://localhost:5000/api';
var allProducts = [];
var deleteId    = null;

// =============================================
// AUTH CHECK ‚Äî Admin only
// =============================================
function checkAuth() {
  var user  = JSON.parse(localStorage.getItem('user')  || 'null');
  var token = localStorage.getItem('token');

  if (!user || !token) {
    document.getElementById('accessDenied').style.display = 'flex';
    return false;
  }
  if (user.role !== 'admin') {
    document.getElementById('accessDenied').style.display = 'flex';
    return false;
  }

  document.getElementById('adminPanel').style.display = 'block';
  document.getElementById('adminName').textContent   = user.name || 'Admin';
  document.getElementById('adminAvatar').textContent = (user.name||'A').charAt(0).toUpperCase();
  return true;
}

function adminLogout() {
  localStorage.removeItem('token');
  localStorage.removeItem('user');
  window.location.href = 'login.html';
}

// =============================================
// LOAD PRODUCTS FROM API
// =============================================
function loadProducts() {
  var token = localStorage.getItem('token');
  fetch(API + '/products?limit=100', {
    headers: { 'Authorization': 'Bearer ' + token }
  })
  .then(function(res) { return res.json(); })
  .then(function(data) {
    allProducts = data.products || data;
    updateStats();
    renderTable(allProducts);
  })
  .catch(function(err) {
    document.getElementById('tableBody').innerHTML =
      '<div class="empty-state"><i class="fa fa-exclamation-circle"></i><p>Could not load products. Make sure backend is running!</p></div>';
  });
}

// =============================================
// UPDATE STATS
// =============================================
function updateStats() {
  var total   = allProducts.length;
  var inStock = allProducts.filter(function(p){ return p.stock > 5; }).length;
  var low     = allProducts.filter(function(p){ return p.stock > 0 && p.stock <= 5; }).length;
  var out     = allProducts.filter(function(p){ return p.stock === 0; }).length;
  document.getElementById('totalProducts').textContent = total;
  document.getElementById('inStockCount').textContent  = inStock;
  document.getElementById('lowStockCount').textContent = low;
  document.getElementById('outStockCount').textContent = out;
}

// =============================================
// RENDER TABLE
// =============================================
function renderTable(products) {
  document.getElementById('productsCount').textContent = products.length + ' products';

  if (products.length === 0) {
    document.getElementById('tableBody').innerHTML =
      '<div class="empty-state"><i class="fa fa-box-open"></i><p>No products found</p></div>';
    return;
  }

  var html = '<table><thead><tr>' +
    '<th>Product</th><th>Category</th><th>Price</th><th>Stock</th><th>Actions</th>' +
    '</tr></thead><tbody>';

  products.forEach(function(p) {
    var stockClass = p.stock === 0 ? 'stock-out' : p.stock <= 5 ? 'stock-low' : 'stock-ok';
    var stockLabel = p.stock === 0 ? 'Out of Stock' : p.stock <= 5 ? 'Low: '+p.stock : 'In Stock: '+p.stock;
    var stockIcon  = p.stock === 0 ? 'fa-times' : p.stock <= 5 ? 'fa-exclamation' : 'fa-check';

    html += '<tr>' +
      '<td><div style="display:flex;align-items:center;gap:12px;">' +
      '<img src="'+(p.image||p.img||'')+'" class="product-thumb" onerror="this.src=\'https://via.placeholder.com/48?text=?\'"/>' +
      '<div><div class="product-name">'+p.name+'</div><div class="product-brand">'+p.brand+'</div></div>' +
      '</div></td>' +
      '<td><span class="category-badge">'+p.category+'</span></td>' +
      '<td class="price-cell">$'+Number(p.price).toFixed(2)+
      (p.oldPrice ? '<span class="old-price">$'+Number(p.oldPrice).toFixed(2)+'</span>' : '') + '</td>' +
      '<td><span class="stock-badge '+stockClass+'"><i class="fa '+stockIcon+'"></i> '+stockLabel+'</span></td>' +
      '<td><div class="action-btns">' +
      '<button class="btn-sm btn-edit" onclick="openEditModal(\''+p._id+'\')"><i class="fa fa-edit"></i> Edit</button>' +
      '<button class="btn-sm btn-delete" onclick="openDeleteModal(\''+p._id+'\',\''+p.name.replace(/'/g,'')+'\')"><i class="fa fa-trash"></i> Delete</button>' +
      '</div></td>' +
      '</tr>';
  });

  html += '</tbody></table>';
  document.getElementById('tableBody').innerHTML = html;
}

// =============================================
// FILTER
// =============================================
function filterProducts() {
  var search    = document.getElementById('searchInput').value.toLowerCase();
  var cat       = document.getElementById('catFilter').value;
  var stockF    = document.getElementById('stockFilter').value;

  var filtered = allProducts.filter(function(p) {
    var matchSearch = !search ||
      p.name.toLowerCase().includes(search) ||
      p.brand.toLowerCase().includes(search);
    var matchCat    = !cat || p.category === cat;
    var matchStock  = !stockF ||
      (stockF==='in'  && p.stock > 5) ||
      (stockF==='low' && p.stock > 0 && p.stock <= 5) ||
      (stockF==='out' && p.stock === 0);
    return matchSearch && matchCat && matchStock;
  });

  renderTable(filtered);
}

// =============================================
// ADD MODAL
// =============================================
function openAddModal() {
  document.getElementById('modalTitle').textContent = 'Add New Product';
  document.getElementById('productId').value = '';
  document.getElementById('pName').value     = '';
  document.getElementById('pBrand').value    = '';
  document.getElementById('pCategory').value = '';
  document.getElementById('pStock').value    = '';
  document.getElementById('pPrice').value    = '';
  document.getElementById('pOldPrice').value = '';
  document.getElementById('pImage').value    = '';
  document.getElementById('pDesc').value     = '';
  document.getElementById('imgPreview').style.display = 'none';
  document.getElementById('modalError').style.display = 'none';
  document.getElementById('saveBtn').innerHTML = '<i class="fa fa-plus"></i> Add Product';
  document.getElementById('productModal').classList.add('show');
}

// =============================================
// EDIT MODAL
// =============================================
function openEditModal(id) {
  var p = allProducts.find(function(x){ return x._id === id; });
  if (!p) return;

  document.getElementById('modalTitle').textContent = 'Edit Product';
  document.getElementById('productId').value  = p._id;
  document.getElementById('pName').value      = p.name;
  document.getElementById('pBrand').value     = p.brand || '';
  document.getElementById('pCategory').value  = p.category;
  document.getElementById('pStock').value     = p.stock;
  document.getElementById('pPrice').value     = p.price;
  document.getElementById('pOldPrice').value  = p.oldPrice || '';
  document.getElementById('pImage').value     = p.image || p.img || '';
  document.getElementById('pDesc').value      = p.description || '';
  document.getElementById('saveBtn').innerHTML = '<i class="fa fa-save"></i> Update Product';
  document.getElementById('modalError').style.display = 'none';

  var prev = document.getElementById('imgPreview');
  if (p.image || p.img) {
    prev.src = p.image || p.img;
    prev.style.display = 'block';
  }

  document.getElementById('productModal').classList.add('show');
}

function closeModal() {
  document.getElementById('productModal').classList.remove('show');
}

// =============================================
// SAVE PRODUCT (Add or Edit)
// =============================================
function saveProduct() {
  var id       = document.getElementById('productId').value;
  var name     = document.getElementById('pName').value.trim();
  var brand    = document.getElementById('pBrand').value.trim();
  var category = document.getElementById('pCategory').value;
  var stock    = document.getElementById('pStock').value;
  var price    = document.getElementById('pPrice').value;
  var oldPrice = document.getElementById('pOldPrice').value;
  var image    = document.getElementById('pImage').value.trim();
  var desc     = document.getElementById('pDesc').value.trim();
  var errEl    = document.getElementById('modalError');

  // Validation
  if (!name || !brand || !category || !stock || !price || !image) {
    errEl.textContent    = '‚ö†Ô∏è Please fill all required fields!';
    errEl.style.display  = 'block';
    return;
  }

  errEl.style.display = 'none';
  var saveBtn = document.getElementById('saveBtn');
  saveBtn.innerHTML = '<i class="fa fa-spinner fa-spin"></i> Saving...';
  saveBtn.disabled  = true;

  var token = localStorage.getItem('token');
  var body  = {
    name: name, brand: brand, category: category,
    stock: Number(stock), price: Number(price),
    oldPrice: oldPrice ? Number(oldPrice) : null,
    image: image, description: desc
  };

  var url    = id ? API + '/products/' + id : API + '/products';
  var method = id ? 'PUT' : 'POST';

  fetch(url, {
    method:  method,
    headers: {
      'Content-Type':  'application/json',
      'Authorization': 'Bearer ' + token
    },
    body: JSON.stringify(body)
  })
  .then(function(res) { return res.json(); })
  .then(function(data) {
    if (data.success) {
      closeModal();
      showToast(id ? '‚úÖ Product updated!' : '‚úÖ Product added!', 'success');
      loadProducts();
    } else {
      errEl.textContent   = data.message || 'Error saving product!';
      errEl.style.display = 'block';
    }
  })
  .catch(function() {
    errEl.textContent   = 'Server error! Make sure backend is running.';
    errEl.style.display = 'block';
  })
  .finally(function() {
    saveBtn.innerHTML = id ? '<i class="fa fa-save"></i> Update Product' : '<i class="fa fa-plus"></i> Add Product';
    saveBtn.disabled  = false;
  });
}

// =============================================
// DELETE
// =============================================
function openDeleteModal(id, name) {
  deleteId = id;
  document.getElementById('deleteProductName').textContent = '"' + name + '" will be permanently deleted!';
  document.getElementById('deleteModal').classList.add('show');
}

function closeDeleteModal() {
  document.getElementById('deleteModal').classList.remove('show');
  deleteId = null;
}

function confirmDelete() {
  if (!deleteId) return;
  var token = localStorage.getItem('token');

  fetch(API + '/products/' + deleteId, {
    method:  'DELETE',
    headers: { 'Authorization': 'Bearer ' + token }
  })
  .then(function(res) { return res.json(); })
  .then(function(data) {
    if (data.success) {
      closeDeleteModal();
      showToast('üóëÔ∏è Product deleted!', 'success');
      loadProducts();
    } else {
      showToast(data.message || 'Delete failed!', 'error');
    }
  })
  .catch(function() {
    showToast('Server error!', 'error');
  });
}

// =============================================
// IMAGE PREVIEW
// =============================================
function previewImg() {
  var url  = document.getElementById('pImage').value.trim();
  var prev = document.getElementById('imgPreview');
  if (url) { prev.src = url; prev.style.display = 'block'; }
  else prev.style.display = 'none';
}

// =============================================
// TOAST
// =============================================
function showToast(msg, type) {
  var toast = document.getElementById('toast');
  document.getElementById('toastMsg').textContent = msg;
  toast.className = 'toast ' + type + ' show';
  setTimeout(function() { toast.className = 'toast'; }, 3000);
}

// =============================================
// SECTION SWITCH
// =============================================
function showSection(section) {
  document.querySelectorAll('.nav-item').forEach(function(n){ n.classList.remove('active'); });
  event.target.closest('.nav-item').classList.add('active');
}

// =============================================
// CLOSE MODAL ON OUTSIDE CLICK
// =============================================
document.getElementById('productModal').addEventListener('click', function(e) {
  if (e.target === this) closeModal();
});
document.getElementById('deleteModal').addEventListener('click', function(e) {
  if (e.target === this) closeDeleteModal();
});

// =============================================
// INIT
// =============================================
window.addEventListener('DOMContentLoaded', function() {
  if (checkAuth()) loadProducts();
});
</script>
</body>
</html>
